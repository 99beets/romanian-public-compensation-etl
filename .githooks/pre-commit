#!/bin/bash
#
# Pre-commit hook for Terraform & large files
# Blocks commits of unwanted files or >50MB objects

# 1. Block Terraform local artifacts
for pattern in ".terraform/" ".terraform" "*.tfstate" "*.tfstate.*" "*.tfplan" "*.zip"; do
    if git diff --cached --name-only | grep -F -q "$pattern"; then
        echo "Commit blocked: Terraform local/state/zip files detected ($pattern)"
        echo "Please add them to .gitignore if needed."
        exit 1
    fi
done

# 2. Block any files > 50MB
large_files=$(git diff --cached --name-only | while read -r file; do
    if [ -f "$file" ]; then
        size=$(du -m "$file" | cut -f1)
        if [ "$size" -gt 50 ]; then
            echo "$file ($size MB)"
        fi    
    fi        
done)

if [ -n "$large_files" ]; then
    echo "Commit blocked: the following files exceed 50MB:"
    echo "$large_files"
    echo "Consider adding them to .gitignore or using Git LFS."
    exit 1
fi

# 3. Run terraform fmt automatically if relevant files changed
if git diff --cached --name-only | grep -E '\.tf$' >/dev/null 2>&1; then
    echo "Running terraform fmt..."
    terraform fmt -recursive >/dev/null 2>&1
    git add *.tf >/dev/null 2>&1
fi

echo "Pre-commit check passed."
exit 0
